<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ä¿„ç¾…æ–¯æ–¹å¡Šé–€å¸‚æ´»å‹•</title>
<style>
  body {
    margin: 0; background: #111; color: #fff; font-family: Arial, sans-serif;
    display: flex; flex-direction: column; align-items: center; min-height: 100vh;
  }
  h1, h2, p { text-align: center; }
  #startScreen, #gameScreen { display: none; }
  button {
    background: #28a745; color: white; border: none; padding: 10px 20px;
    font-size: 18px; border-radius: 5px; cursor: pointer;
  }
  button:hover { background: #218838; }
  canvas { background: #000; margin-top: 20px; }
  .controls { margin-top: 20px; }
  .control-btn {
    background: #444; color: #fff; border: none; padding: 10px;
    margin: 5px; font-size: 18px; border-radius: 5px;
  }
  .control-btn:active { background: #666; }
</style>
</head>
<body>

<div id="startScreen">
  <h1>ä¿„ç¾…æ–¯æ–¹å¡ŠæŒ‘æˆ°</h1>
  <h2>éŠæˆ²èªªæ˜</h2>
  <p>æ¶ˆé™¤è¶Šå¤šè¡Œã€åˆ†æ•¸è¶Šé«˜ï¼å°å¿ƒåˆ¥è®“æ–¹å¡Šå †åˆ°é ‚ç«¯ï¼</p>
  
  <h3>ğŸ“Œ é›»è…¦æ“ä½œ</h3>
  <ul style="text-align:left;max-width:320px;margin:auto;">
    <li>â†ï¼šå‘å·¦ç§»å‹•</li>
    <li>â†’ï¼šå‘å³ç§»å‹•</li>
    <li>â†“ï¼šåŠ é€Ÿä¸‹è½ï¼ˆå¯é•·æŒ‰ï¼‰</li>
    <li>ç©ºç™½éµï¼šç›´æ¥è½ä¸‹ï¼ˆHard Dropï¼‰</li>
    <li>Qï¼šé€†æ™‚é‡æ—‹è½‰</li>
    <li>Wï¼šé †æ™‚é‡æ—‹è½‰</li>
  </ul>

  <h3>ğŸ“Œ æ‰‹æ©Ÿæ“ä½œ</h3>
  <ul style="text-align:left;max-width:320px;margin:auto;">
    <li>å·¦å³ç®­é ­ï¼šå·¦å³ç§»å‹•</li>
    <li>ä¸‹ç®­é ­ï¼šåŠ é€Ÿä¸‹è½ï¼ˆé•·æŒ‰å¯é€£çºŒï¼‰</li>
    <li>æ—‹è½‰æŒ‰éˆ•ï¼šæ—‹è½‰æ–¹å¡Š</li>
    <li>ã€Œç›´æ¥è½ä¸‹ã€æŒ‰éˆ•ï¼šæ–¹å¡Šç¬é–“åˆ°åº•</li>
  </ul>

  <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
</div>

<div id="gameScreen">
  <canvas id="tetris" width="240" height="400"></canvas>
  <div class="controls">
    <button class="control-btn" id="leftBtn">â†</button>
    <button class="control-btn" id="rotateLeftBtn">âŸ²</button>
    <button class="control-btn" id="rotateRightBtn">âŸ³</button>
    <button class="control-btn" id="rightBtn">â†’</button>
    <button class="control-btn" id="downBtn">â†“</button>
    <button class="control-btn" id="dropBtn">ç›´æ¥è½ä¸‹</button>
  </div>
</div>

<script>
// éŠæˆ²åˆå§‹åŒ–
const canvas = document.getElementById('tetris');
const context = canvas.getContext('2d');
context.scale(20, 20);

const matrix = [
  [0, 0, 0],
  [1, 1, 1],
  [0, 1, 0],
];

const arena = createMatrix(12, 20);

function createMatrix(w, h) {
  const matrix = [];
  while (h--) {
    matrix.push(new Array(w).fill(0));
  }
  return matrix;
}

function collide(arena, player) {
  const [m, o] = [player.matrix, player.pos];
  for (let y = 0; y < m.length; ++y) {
    for (let x = 0; x < m[y].length; ++x) {
      if (m[y][x] !== 0 &&
         (arena[y + o.y] &&
          arena[y + o.y][x + o.x]) !== 0) {
        return true;
      }
    }
  }
  return false;
}

function merge(arena, player) {
  player.matrix.forEach((row, y) => {
    row.forEach((value, x) => {
      if (value !== 0) {
        arena[y + player.pos.y][x + player.pos.x] = value;
      }
    });
  });
}

function playerDrop() {
  player.pos.y++;
  if (collide(arena, player)) {
    player.pos.y--;
    merge(arena, player);
    playerReset();
    arenaSweep();
  }
  dropCounter = 0;
}

function playerHardDrop() {
  while (!collide(arena, player)) {
    player.pos.y++;
  }
  player.pos.y--;
  merge(arena, player);
  playerReset();
  arenaSweep();
  dropCounter = 0;
}

function playerMove(dir) {
  player.pos.x += dir;
  if (collide(arena, player)) {
    player.pos.x -= dir;
  }
}

function playerReset() {
  const pieces = 'TJLOSZI';
  player.matrix = createPiece(pieces[pieces.length * Math.random() | 0]);
  player.pos.y = 0;
  player.pos.x = (arena[0].length / 2 | 0) -
                 (player.matrix[0].length / 2 | 0);
  if (collide(arena, player)) {
    arena.forEach(row => row.fill(0));
    gameOver = true;
    alert('éŠæˆ²çµæŸï¼');
    document.getElementById('startScreen').style.display = 'block';
    document.getElementById('gameScreen').style.display = 'none';
  }
}

function createPiece(type) {
  if (type === 'T') {
    return [
      [0,0,0],
      [1,1,1],
      [0,1,0],
    ];
  } else if (type === 'O') {
    return [
      [2,2],
      [2,2],
    ];
  } else if (type === 'L') {
    return [
      [0,3,0],
      [0,3,0],
      [0,3,3],
    ];
  } else if (type === 'J') {
    return [
      [0,4,0],
      [0,4,0],
      [4,4,0],
    ];
  } else if (type === 'I') {
    return [
      [0,5,0,0],
      [0,5,0,0],
      [0,5,0,0],
      [0,5,0,0],
    ];
  } else if (type === 'S') {
    return [
      [0,6,6],
      [6,6,0],
      [0,0,0],
    ];
  } else if (type === 'Z') {
    return [
      [7,7,0],
      [0,7,7],
      [0,0,0],
    ];
  }
}

function playerRotate(dir) {
  const pos = player.pos.x;
  let offset = 1;
  rotate(player.matrix, dir);
  while (collide(arena, player)) {
    player.pos.x += offset;
    offset = -(offset + (offset > 0 ? 1 : -1));
    if (offset > player.matrix[0].length) {
      rotate(player.matrix, -dir);
      player.pos.x = pos;
      return;
    }
  }
}

function rotate(matrix, dir) {
  for (let y = 0; y < matrix.length; ++y) {
    for (let x = 0; x < y; ++x) {
      [ matrix[x][y], matrix[y][x] ] = [ matrix[y][x], matrix[x][y] ];
    }
  }
  if (dir > 0) {
    matrix.forEach(row => row.reverse());
  } else {
    matrix.reverse();
  }
}

function arenaSweep() {
  outer: for (let y = arena.length - 1; y >= 0; --y) {
    for (let x = 0; x < arena[y].length; ++x) {
      if (arena[y][x] === 0) {
        continue outer;
      }
    }
    const row = arena.splice(y, 1)[0].fill(0);
    arena.unshift(row);
    ++y;
  }
}

let dropCounter = 0;
let dropInterval = 1000;
let lastTime = 0;
let gameOver = false;

function update(time = 0) {
  const deltaTime = time - lastTime;
  lastTime = time;
  dropCounter += deltaTime;
  if (dropCounter > dropInterval) {
    playerDrop();
  }
  draw();
  requestAnimationFrame(update);
}

function draw() {
  context.fillStyle = '#000';
  context.fillRect(0, 0, canvas.width, canvas.height);
  drawMatrix(arena, {x:0, y:0});
  drawMatrix(player.matrix, player.pos);
}

function drawMatrix(matrix, offset) {
  matrix.forEach((row, y) => {
    row.forEach((value, x) => {
      if (value !== 0) {
        context.fillStyle = 'hsl(' + value * 60 + ', 100%, 50%)';
        context.fillRect(x + offset.x, y + offset.y, 1, 1);
      }
    });
  });
}

const player = {
  pos: {x:0, y:0},
  matrix: null,
};

// éµç›¤é•·æŒ‰åŠŸèƒ½
const keysPressed = {};
const keyHoldInterval = {};

function keyDownHandler(event) {
  if (gameOver) return;
  if (keysPressed[event.key]) return;
  keysPressed[event.key] = true;
  switch(event.key) {
    case 'ArrowLeft':
      playerMove(-1);
      keyHoldInterval['ArrowLeft'] = setInterval(() => playerMove(-1), 100);
      break;
    case 'ArrowRight':
      playerMove(1);
      keyHoldInterval['ArrowRight'] = setInterval(() => playerMove(1), 100);
      break;
    case 'ArrowDown':
      playerDrop();
      keyHoldInterval['ArrowDown'] = setInterval(() => playerDrop(), 100);
      break;
    case 'q':
    case 'Q':
      playerRotate(-1);
      keyHoldInterval['q'] = setInterval(() => playerRotate(-1), 200);
      break;
    case 'w':
    case 'W':
      playerRotate(1);
      keyHoldInterval['w'] = setInterval(() => playerRotate(1), 200);
      break;
    case ' ':
      playerHardDrop();
      break;
  }
}

function keyUpHandler(event) {
  keysPressed[event.key] = false;
  if (keyHoldInterval[event.key]) {
    clearInterval(keyHoldInterval[event.key]);
    keyHoldInterval[event.key] = null;
  }
}

document.addEventListener('keydown', keyDownHandler);
document.addEventListener('keyup', keyUpHandler);

// æ‰‹æ©ŸæŒ‰éˆ•
function bindButton(id, action, interval = 100) {
  const btn = document.getElementById(id);
  let timer;
  btn.addEventListener('touchstart', e => {
    e.preventDefault();
    action();
    timer = setInterval(action, interval);
  });
  btn.addEventListener('touchend', e => {
    clearInterval(timer);
  });
}

bindButton('leftBtn', () => playerMove(-1));
bindButton('rightBtn', () => playerMove(1));
bindButton('downBtn', () => playerDrop());
bindButton('rotateLeftBtn', () => playerRotate(-1), 200);
bindButton('rotateRightBtn', () => playerRotate(1), 200);
document.getElementById('dropBtn').addEventListener('click', playerHardDrop);

function startGame() {
  document.getElementById('startScreen').style.display = 'none';
  document.getElementById('gameScreen').style.display = 'block';
  playerReset();
  update();
}
</script>

</body>
</html>
