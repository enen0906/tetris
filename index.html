<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>俄羅斯方塊門市活動</title>
<style>
  body {
    margin: 0; background: #111; color: #fff; font-family: Arial, sans-serif;
    display: flex; flex-direction: column; align-items: center; min-height: 100vh; text-align: center;
  }
  #home, #game, #end {
    max-width: 400px; width: 100%; padding: 10px; box-sizing: border-box;
    display: none;
  }
  button {
    background: #03a9f4; border: none; color: white; padding: 12px 20px;
    margin: 10px 5px; font-size: 18px; border-radius: 8px; cursor: pointer;
  }
  button:active { background: #0288d1; }
  canvas {
    background: #222; display: block; margin: 20px auto; border: 4px solid #fff;
  }
  #controls { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
  #controls button { flex: 1 1 70px; }
  input, select {
    width: 80%; padding: 10px; margin: 8px 0; border-radius: 6px; border: none; font-size: 16px;
  }
</style>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>

<!-- 首頁 -->
<div id="home">
  <h2>🎮 俄羅斯方塊挑戰</h2>
  <p>遊戲規則與操作說明：</p>
  <ul style="text-align:left; line-height: 1.6;">
    <li>🎯 遊戲目標：排列方塊使橫向行數滿行即可消除，得分越高越好。</li>
    <li>⏱️ 遊戲模式：
      <ul>
        <li>達成 500 分挑戰：目標累積得分達 500 分即完成。</li>
        <li>三分鐘挑戰：限時 3 分鐘內盡可能得高分。</li>
      </ul>
    </li>
    <li>🕹 操作方式：
      <ul>
        <li>左移：按「◀️」按鈕或鍵盤左方向鍵</li>
        <li>右移：按「▶️」按鈕或鍵盤右方向鍵</li>
        <li>加速落下：按「🔽」按鈕或鍵盤下方向鍵</li>
        <li>旋轉方塊：按「🔄」按鈕，或鍵盤「Q」「W」鍵旋轉</li>
        <li>直接落下：按「⬇️⬇️」按鈕，或鍵盤空白鍵 (Spacebar)</li>
      </ul>
    </li>
    <li>🎁 完成挑戰後可至指定門市領取贈品！</li>
  </ul>
  <button onclick="startMode('500')">🎯 達成 500 分挑戰</button>
  <button onclick="startMode('3min')">⏱️ 三分鐘挑戰</button>
</div>

<!-- 遊戲頁 -->
<div id="game">
  <div>分數：<span id="score">0</span></div>
  <div>時間：<span id="timer">0</span> 秒</div>
  <canvas id="tetris" width="240" height="400"></canvas>
  <div id="controls">
    <button id="left">◀️</button>
    <button id="right">▶️</button>
    <button id="down">🔽</button>
    <button id="hardDrop">⬇️⬇️</button>
    <button id="rotate">🔄</button>
  </div>
</div>

<!-- 結束頁 -->
<div id="end">
  <h2>🎉 恭喜完成挑戰！</h2>
  <p id="result"></p>
  <input id="nickname" type="text" placeholder="請輸入暱稱（必填）" />
  <select id="store">
    <option value="">選擇領取門市（必填）</option>
    <option value="成大校園門市">成大校園門市</option>
    <option value="南臺校園門市">南臺校園門市</option>
  </select>
  <br/>
  <button onclick="submitResult()">提交成績並領取贈品</button>
</div>

<script>
const LIFF_ID = '2007597530-Dmy8j9mN';  // 請改成你的 LIFF ID
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzfXLDN7FBYV9Zpukea2emKOEZNntkvl49iH6kbVaAtUPLFzQCri6XhA4ftK_S7pk3ddA/exec';  // 請改成你的 GAS 網址

let mode = '';
let score = 0;
let timer = 0;
let timerInterval;
let dropInterval = 1000;
let dropCounter = 0;
let lastTime = 0;
let gameOver = false;
let player = { pos: {x:0,y:0}, matrix: null };
let arena = createMatrix(12,20);
const colors = [null,'#FF0D72','#0DC2FF','#0DFF72','#F538FF','#FF8E0D','#FFE138','#3877FF'];

const homeDiv = document.getElementById('home');
const gameDiv = document.getElementById('game');
const endDiv = document.getElementById('end');
const canvas = document.getElementById('tetris');
const context = canvas.getContext('2d');
context.scale(20, 20);

function createMatrix(w, h) { const matrix = []; while (h--) matrix.push(new Array(w).fill(0)); return matrix; }
function createPiece(type) {
  switch(type){
    case 'T': return [[0,0,0],[1,1,1],[0,1,0]];
    case 'O': return [[2,2],[2,2]];
    case 'L': return [[0,3,0],[0,3,0],[0,3,3]];
    case 'J': return [[0,4,0],[0,4,0],[4,4,0]];
    case 'I': return [[0,5,0,0],[0,5,0,0],[0,5,0,0],[0,5,0,0]];
    case 'S': return [[0,6,6],[6,6,0],[0,0,0]];
    case 'Z': return [[7,7,0],[0,7,7],[0,0,0]];
  }
}
function collide(arena, player) {
  const [m, o] = [player.matrix, player.pos];
  for(let y=0; y<m.length; ++y){
    for(let x=0; x<m[y].length; ++x){
      if(m[y][x] !== 0 && (arena[y + o.y] && arena[y + o.y][x + o.x]) !== 0){
        return true;
      }
    }
  }
  return false;
}
function merge(arena, player) {
  player.matrix.forEach((row,y) => {
    row.forEach((value,x) => {
      if(value !== 0){
        arena[y + player.pos.y][x + player.pos.x] = value;
      }
    });
  });
}
function rotate(matrix, dir) {
  for(let y=0; y<matrix.length; ++y){
    for(let x=0; x<y; ++x){
      [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];
    }
  }
  if(dir > 0){
    matrix.forEach(row => row.reverse());
  } else {
    matrix.reverse();
  }
}
function playerRotate(dir){
  const pos = player.pos.x;
  let offset = 1;
  rotate(player.matrix, dir);
  while(collide(arena, player)){
    player.pos.x += offset;
    offset = -(offset + (offset > 0 ? 1 : -1));
    if(Math.abs(offset) > player.matrix[0].length){
      rotate(player.matrix, -dir);
      player.pos.x = pos;
      return;
    }
  }
}
// 玩家直接硬下方塊
function playerHardDrop() {
  while(!collide(arena, player)){
    player.pos.y++;
  }
  player.pos.y--;
  merge(arena, player);
  arenaSweep();
  updateScore();
  playerReset();
}

function playerDrop() {
  player.pos.y++;
  if(collide(arena, player)){
    player.pos.y--;
    merge(arena, player);
    arenaSweep();
    updateScore();
    if(mode === '500' && score >= 500){
      endGame();
      return;
    }
    playerReset();
  }
  dropCounter = 0;
}
function playerMove(dir) {
  player.pos.x += dir;
  if(collide(arena, player)){
    player.pos.x -= dir;
  }
}
function playerReset() {
  const pieces = 'ILJOTSZ';
  player.matrix = createPiece(pieces[Math.floor(Math.random() * pieces.length)]);
  player.pos.y = 0;
  player.pos.x = Math.floor(arena[0].length / 2) - Math.floor(player.matrix[0].length / 2);
  if(collide(arena, player)){
    arena.forEach(row => row.fill(0));
    score = 0;
    updateScore();
    endGame();
  }
}
function arenaSweep() {
  let rowCount = 1;
  outer: for(let y=arena.length -1; y>=0; --y){
    for(let x=0; x<arena[y].length; ++x){
      if(arena[y][x] === 0){
        continue outer;
      }
    }
    const row = arena.splice(y,1)[0].fill(0);
    arena.unshift(row);
    score += rowCount * 50;
    rowCount *= 2;
  }
}
function updateScore() {
  document.getElementById('score').innerText = score;
}
function drawMatrix(matrix, offset){
  matrix.forEach((row,y) => {
    row.forEach((value,x) => {
      if(value !== 0){
        context.fillStyle = colors[value];
        context.fillRect(x + offset.x, y + offset.y, 1, 1);
      }
    });
  });
}
function draw() {
  context.fillStyle = '#222';
  context.fillRect(0, 0, canvas.width, canvas.height);
  drawMatrix(arena, {x:0, y:0});
  drawMatrix(player.matrix, player.pos);
}
function update(time = 0){
  const deltaTime = time - lastTime;
  lastTime = time;
  dropCounter += deltaTime;
  if(dropCounter > dropInterval){
    playerDrop();
  }
  draw();
  if(!gameOver){
    requestAnimationFrame(update);
  }
}
function startTimer(){
  timer = 0;
  document.getElementById('timer').innerText = timer;
  timerInterval = setInterval(() => {
    timer++;
    document.getElementById('timer').innerText = timer;
    if(mode === '3min' && timer >= 180){
      endGame();
    }
  }, 1000);
}
function stopTimer(){
  clearInterval(timerInterval);
}
function startGame() {
  arena.forEach(row => row.fill(0));
  score = 0;
  updateScore();
  playerReset();
  lastTime = 0;
  dropCounter = 0;
  dropInterval = 1000;
  gameOver = false;
  homeDiv.style.display = 'none';
  endDiv.style.display = 'none';
  gameDiv.style.display = 'block';
  startTimer();
  update();
}
function endGame() {
  stopTimer();
  gameOver = true;
  gameDiv.style.display = 'none';
  endDiv.style.display = 'block';
  document.getElementById('result').innerText = `遊戲時間：${timer} 秒，分數：${score}`;
}

document.getElementById('left').addEventListener('mousedown', () => {
  holdInterval = setInterval(() => playerMove(-1), 100);
});
document.getElementById('left').addEventListener('mouseup', () => {
  clearInterval(holdInterval);
});
document.getElementById('left').addEventListener('mouseleave', () => {
  clearInterval(holdInterval);
});

document.getElementById('right').addEventListener('mousedown', () => {
  holdInterval = setInterval(() => playerMove(1), 100);
});
document.getElementById('right').addEventListener('mouseup', () => {
  clearInterval(holdInterval);
});
document.getElementById('right').addEventListener('mouseleave', () => {
  clearInterval(holdInterval);
});

document.getElementById('down').addEventListener('mousedown', () => {
  holdInterval = setInterval(() => playerDrop(), 50);
});
document.getElementById('down').addEventListener('mouseup', () => {
  clearInterval(holdInterval);
});
document.getElementById('down').addEventListener('mouseleave', () => {
  clearInterval(holdInterval);
});

document.getElementById('hardDrop').addEventListener('click', () => {
  playerHardDrop();
});

document.getElementById('rotate').addEventListener('click', () => playerRotate(1));
document.addEventListener('keydown', event => {
  if(gameOver) return;
  if(event.key === 'ArrowLeft'){
    playerMove(-1);
  }
  else if(event.key === 'ArrowRight'){
    playerMove(1);
  }
  else if(event.key === 'ArrowDown'){
    playerDrop();
  }
  else if(event.key.toLowerCase() === 'q'){
    playerRotate(-1);
  }
  else if(event.key.toLowerCase() === 'w'){
    playerRotate(1);
  }
  else if(event.key === ' '){  // 空白鍵硬下
    playerHardDrop();
  }
});

function startMode(selectedMode){
  mode = selectedMode;
  startGame();
}

async function submitResult() {
  const nicknameInput = document.getElementById('nickname');
  const nickname = nicknameInput.value.trim();
  const store = document.getElementById('store').value.trim();

  if (!nickname) {
    alert('請輸入暱稱');
    nicknameInput.focus();
    return;
  }
  if (!store) {
    alert('請選擇領取門市');
    return;
  }

  const params = new URLSearchParams({
    nickname: nickname,
    mode: mode === '500' ? '達成 500 分計時挑戰' : '三分鐘計時挑戰',
    score: score.toString(),
    time: timer.toString(),
    store: store
  });

  try {
    const res = await fetch(`${GAS_URL}?${params.toString()}`, {
      method: 'GET',
    });

    if (!res.ok) {
      throw new Error(`HTTP 錯誤 ${res.status}`);
    }

    alert('已成功提交，請攜帶手機截圖至門市領取贈品！');
    location.reload();
  } catch (e) {
    alert('提交失敗：' + e.message);
  }
}

liff.init({ liffId: LIFF_ID })
  .then(() => {
    if (!liff.isLoggedIn()) {
      liff.login();
    } else {
      homeDiv.style.display = 'block';
    }
  })
  .catch(err => {
    alert('LIFF 初始化失敗：' + err.message);
  });
</script>
</body>
</html>
